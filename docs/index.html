<!DOCTYPE html>
<html lang="uk">
<head>

  <style>
  #mapContainer {
    height: 500px;
    margin-bottom: 20px;
  }
  #controlPanel {
    margin: 10px 0;
  }
  #controlPanel button {
    margin-right: 10px;
    padding: 6px 12px;
    font-weight: bold;
    cursor: pointer;
  }
  .hidden {
    display: none;
  }
  #nameInputContainer {
    position: absolute;
    top: 100px;
    left: 50px;
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    z-index: 999;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
  }
</style>

  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPON –ü–ª–∞–Ω</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet GeometryUtil (–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.geometryutil/0.9.3/leaflet.geometryutil.min.js"></script>
</head>
<body>
  <h1>GPON –ü–ª–∞–Ω</h1>
  
  <div id="controlPanel">
  <button onclick="setMode('box')">–î–æ–±–∞–≤–∏—Ç—å –±–æ–∫—Å üü•</button>
  <button onclick="setMode('splice')">–î–æ–±–∞–≤–∏—Ç—å –º—É—Ñ—Ç—É üîµ</button>
  <button onclick="setMode('cable')">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–±–µ–ª—å üìè</button>
</div>
  
  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ -->
  <div id="map" style="height: 500px;"></div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ —É–∑–ª–∞ -->
  <div id="nameInputContainer" class="hidden">
    <input type="text" id="nodeName" placeholder="–ù–∞–∑–≤–∞ –≤—É–∑–ª–∞" />
    <button onclick="saveNodeName()">–û–ö</button>
  </div>

  <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–∞–±–µ–ª—è -->
  <div>
    <label for="cableType">–¢–∏–ø –∫–∞–±–µ–ª—é:</label>
    <select id="cableType">
      <option value="4">4 –≤–æ–ª–æ–∫–Ω–∞</option>
      <option value="8">8 –≤–æ–ª–æ–∫–æ–Ω</option>
      <option value="12">12 –≤–æ–ª–æ–∫–æ–Ω</option>
      <option value="24">24 –≤–æ–ª–æ–∫–Ω–∞</option>
      <option value="48">48 –≤–æ–ª–æ–∫–æ–Ω</option>
      <option value="96">96 –≤–æ–ª–æ–∫–æ–Ω</option>
      <option value="144">144 –≤–æ–ª–æ–∫–Ω–∞</option>
    </select>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞–±–µ–ª–µ–π -->
  <table border="1">
    <thead>
      <tr>
        <th>#</th>
        <th>–¢–∏–ø</th>
        <th>–û—Ç</th>
        <th>–î–æ</th>
        <th>–î–ª–∏–Ω–∞</th>
      </tr>
    </thead>
    <tbody id="cableTableBody"></tbody>
  </table>

  <!-- –°–∫—Ä–∏–ø—Ç -->
  <script>
    let map = L.map('map').setView([48.3794, 31.1656], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let mode = null;
    let cablePath = [];
    let cableSegments = [];
    let markers = [];
    let cables = [];
    let currentFeature = null;

    function setMode(m) {
      mode = m;
      cablePath = [];
      currentFeature = null;
    }

    map.on('click', function(e) {
      if (mode === 'box' || mode === 'splice') {
        currentFeature = {
          type: mode,
          latlng: e.latlng
        };
        showInputBox();
      } else if (mode === 'cable') {
        cablePath.push(e.latlng);
        if (cablePath.length >= 2) {
          drawCable();
        }
      }
    });

    function showInputBox() {
      document.getElementById('nameInputContainer').classList.remove('hidden');
      document.getElementById('nodeName').focus();
    }

    function saveNodeName() {
      const name = document.getElementById('nodeName').value;
      if (name && currentFeature) {
        const iconHtml = currentFeature.type === 'box'
          ? `<div style="color: blue; font-weight: bold;">üü•<br>${name}</div>`
          : `<div style="color: green; font-weight: bold;">üîµ<br>${name}</div>`;

        const icon = L.divIcon({
          html: iconHtml,
          iconSize: [50, 50],
          className: ''
        });

        const marker = L.marker(currentFeature.latlng, {
          icon: icon,
          draggable: false
        }).addTo(map);

        marker.bindPopup(`${name} (${currentFeature.type})`);
        marker.name = name;

        markers.push({ marker, name, type: currentFeature.type, latlng: currentFeature.latlng });

        currentFeature = null;
      }

      document.getElementById('nodeName').value = '';
      document.getElementById('nameInputContainer').classList.add('hidden');
    }

    function drawCable() {
      const cableType = document.getElementById('cableType').value;

      const polyline = L.polyline(cablePath, {
        color: 'red',
        weight: 3,
        dashArray: '5,5'
      }).addTo(map);

      const from = findNearestMarker(cablePath[0]);
      const to = findNearestMarker(cablePath[cablePath.length - 1]);

      const distance = L.GeometryUtil.length(cablePath) / 1000; // –≤ –∫–º

      const info = {
        type: cableType,
        from: from ? from.name : `(${cablePath[0].lat.toFixed(5)}, ${cablePath[0].lng.toFixed(5)})`,
        to: to ? to.name : `(${cablePath[cablePath.length - 1].lat.toFixed(5)}, ${cablePath[cablePath.length - 1].lng.toFixed(5)})`,
        length: distance.toFixed(2) + ' –∫–º'
      };

      polyline.bindPopup(`–ö–∞–±–µ–ª—å: ${cableType} –≤–æ–ª–æ–∫–æ–Ω<br>–î–ª–∏–Ω–∞: ${info.length}<br>–û—Ç: ${info.from}<br>–î–æ: ${info.to}`);

      cables.push({ polyline, info });
      cablePath = [];
      updateCableTable();
    }

    function findNearestMarker(latlng) {
      let minDist = Infinity;
      let nearest = null;
      markers.forEach(m => {
        const d = map.distance(latlng, m.latlng);
        if (d < 20) nearest = m;
      });
      return nearest;
    }

    function updateCableTable() {
      const tbody = document.getElementById('cableTableBody');
      tbody.innerHTML = '';
      cables.forEach((c, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${c.info.type}</td>
          <td>${c.info.from}</td>
          <td>${c.info.to}</td>
          <td>${c.info.length}</td>
        `;
        tbody.appendChild(row);
      });
    }
  </script>
</body>
</html>
