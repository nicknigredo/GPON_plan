<!DOCTYPE html>
<html lang="uk">
<head>
  <!--<meta charset="UTF-8" />
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!--<title>GPON –ü–ª–∞–Ω</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet GeometryUtil -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.geometryutil/0.9.3/leaflet.geometryutil.min.js"></script>

  <style>
    #map {
      height: 500px;
      margin-bottom: 20px;
    }
    #controlPanel {
      margin: 10px 0;
    }
    #controlPanel button {
      margin-right: 10px;
      padding: 6px 12px;
      font-weight: bold;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
    #nameInputContainer {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      z-index: 999;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!--<h1>GPON –ü–ª–∞–Ω</h1>

  <div id="controlPanel">
    <button onclick="setMode('box')">–î–æ–±–∞–≤–∏—Ç—å –±–æ–∫—Å üü•</button>
    <button onclick="setMode('splice')">–î–æ–±–∞–≤–∏—Ç—å –º—É—Ñ—Ç—É üîµ</button>
    <button onclick="setMode('cable')">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–±–µ–ª—å üìè</button>
    <button onclick="finishCable()" id="finishCableBtn" class="hidden">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–∞—Å—Å—É ‚úÖ</button>
  </div>

  <div id="map"></div>

  <div id="nameInputContainer" class="hidden">
    <input type="text" id="nodeName" placeholder="–ù–∞–∑–≤–∞ –≤—É–∑–ª–∞" />
    <button onclick="saveNodeName()">–û–ö</button>
  </div>

  <div>
    <label for="cableType">–¢–∏–ø –∫–∞–±–µ–ª—é:</label>
    <select id="cableType">
      <option value="4">4 –≤–æ–ª–æ–∫–Ω–∞</option>
      <option value="8">8 –≤–æ–ª–æ–∫–æ–Ω</option>
      <option value="12">12 –≤–æ–ª–æ–∫–æ–Ω</option>
      <option value="24">24 –≤–æ–ª–æ–∫–Ω–∞</option>
      <option value="48">48 –≤–æ–ª–æ–∫–æ–Ω</option>
      <option value="96">96 –≤–æ–ª–æ–∫–æ–Ω</option>
      <option value="144">144 –≤–æ–ª–æ–∫–Ω–∞</option>
    </select>
  </div>

  <table border="1">
    <thead>
      <tr>
        <th>#</th>
        <th>–¢–∏–ø</th>
        <th>–û—Ç</th>
        <th>–î–æ</th>
        <th>–î–ª–∏–Ω–∞</th>
      </tr>
    </thead>
    <tbody id="cableTableBody"></tbody>
  </table>

  <script>
    let map = L.map('map').setView([48.3794, 31.1656], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let mode = null;
    let cablePath = [];
    let markers = [];
    let cables = [];
    let currentFeature = null;

    function setMode(m) {
      mode = m;
      cablePath = [];
      currentFeature = null;
      document.getElementById('finishCableBtn').classList.toggle('hidden', m !== 'cable');
    }

    map.on('click', function(e) {
      if (mode === 'box' || mode === 'splice') {
        currentFeature = { type: mode, latlng: e.latlng };
        showInputBox(e.latlng);
      } else if (mode === 'cable') {
        cablePath.push(e.latlng);
        L.circleMarker(e.latlng, { radius: 4, color: 'red' }).addTo(map);
      }
    });

    function showInputBox(latlng) {
      const container = document.getElementById('nameInputContainer');
      const point = map.latLngToContainerPoint(latlng);
      container.style.top = `${point.y + 40}px`;
      container.style.left = `${point.x + 40}px`;
      container.classList.remove('hidden');
      document.getElementById('nodeName').focus();
    }

    function saveNodeName() {
      const name = document.getElementById('nodeName').value;
      if (name && currentFeature) {
        const iconHtml = currentFeature.type === 'box'
          ? `<div style="color: blue; font-weight: bold;">üü•<br>${name}</div>`
          : `<div style="color: green; font-weight: bold;">üîµ<br>${name}</div>`;

        const icon = L.divIcon({ html: iconHtml, iconSize: [50, 50], className: '' });

        const marker = L.marker(currentFeature.latlng, { icon: icon }).addTo(map);
        marker.bindPopup(`${name} (${currentFeature.type})`);
        marker.name = name;

        markers.push({ marker, name, type: currentFeature.type, latlng: currentFeature.latlng });
        currentFeature = null;
      }

      document.getElementById('nodeName').value = '';
      document.getElementById('nameInputContainer').classList.add('hidden');
    }

    function finishCable() {
      if (cablePath.length < 2) return alert('–ü–æ—Ç—Ä—ñ–±–Ω–æ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 2 —Ç–æ—á–∫–∏.');

      const cableType = document.getElementById('cableType').value;
      const polyline = L.polyline(cablePath, {
        color: 'red',
        weight: 3,
        dashArray: '5,5'
      }).addTo(map);

      const from = findNearestMarker(cablePath[0]);
      const to = findNearestMarker(cablePath[cablePath.length - 1]);

      const distance = L.GeometryUtil.length(cablePath) / 1000;

      const info = {
        type: cableType,
        from: from ? from.name : '???',
        to: to ? to.name : '???',
        length: distance.toFixed(2) + ' –∫–º'
      };

      polyline.bindPopup(`–ö–∞–±–µ–ª—å: ${cableType} –≤–æ–ª–æ–∫–æ–Ω<br>–î–ª–∏–Ω–∞: ${info.length}<br>–û—Ç: ${info.from}<br>–î–æ: ${info.to}`);
      cables.push({ polyline, info });

      cablePath = [];
      updateCableTable();
    }

    function findNearestMarker(latlng) {
      let nearest = null;
      let minDist = Infinity;
      for (const m of markers) {
        const d = map.distance(latlng, m.latlng);
        if (d < 50 && d < minDist) {
          minDist = d;
          nearest = m;
        }
      }
      return nearest;
    }

    function updateCableTable() {
      const tbody = document.getElementById('cableTableBody');
      tbody.innerHTML = '';
      cables.forEach((c, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${c.info.type}</td>
          <td>${c.info.from}</td>
          <td>${c.info.to}</td>
          <td>${c.info.length}</td>
        `;
        tbody.appendChild(row);
      });
    }
  </script>
</body>
</html>
